# Stage: 1
FROM ubuntu:22.04 as builder
ARG EVIL_PROXY_IP
# Update Ubuntu, install WGet, Python2, and apt-key add 
RUN apt-get update && apt-get install -y \ 
    wget software-properties-common python2.7
#   add diladele apt key
RUN wget -qO - https://packages.diladele.com/diladele_pub.asc | apt-key add -
#   add new repo
RUN echo "deb https://squid413-ubuntu20.diladele.com/ubuntu/ focal main" \ > /etc/apt/sources.list.d/squid413-ubuntu20.diladele.com.list
#   and install
RUN apt-get update && apt-get install -y \
        squid-common \
        squid-openssl \
        squidclient \
        libecap3 libecap3-dev
COPY squid.conf /etc/squid/squid.conf
COPY rewrite.py /rewrite.py
# Expose log files generated by rewrite.py 
RUN ln -sf /dev/stdout /tmp/rewrite_js_log
RUN ln -sf /dev/stdout /tmp/rewrite_html_log
# RUN ln -sf /dev/stdout /var/log/squid/access.log
# Expose HTTP proxy port
EXPOSE 8080
# Modify SSL certificates so they can be loaded 
RUN mkdir -p /var/lib/ssl_db
COPY ./run.sh /run.sh 
CMD '/run.sh'